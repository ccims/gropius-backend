<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gropius-Login-Tester</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        h4 {
            margin-block-end: 0;
        }

        pre,
        .body {
            font-family: 'Cascadia Mono', 'Consolas', 'Courier New', Courier, monospace;
            margin: 0;
            white-space: nowrap;
        }
    </style>
    <script>
        const currentUrl = new URL(window.location.href);
        let oauthCode = undefined;
        if (currentUrl.searchParams.has("code")) {
            oauthCode = currentUrl.searchParams.get("code");
            console.error("Called with code " + currentUrl.searchParams.get("code"));
            currentUrl.searchParams.delete("code");
            if (window.opener) {
                window.postMessage(oauthCode);
                oauthCode = undefined;
                this.close();
            } else {
                window.history.replaceState(history.state, document.title, currentUrl);
            }
        }

        let loginUrl;
        let logType = "console";
        let accessToken = undefined;
        let createClientRedirectUrls = "[]";

        function log(...data) {
            switch (logType) {
                case "console":
                case "console+alert":
                    console.log(...(data.map(d => typeof d == "string" ? (d + "\n") : d)));
                    if (logType != "console+alert") {
                        break;
                    }
                case "alert":
                    alert(data.map(d => typeof d == "object" ? JSON.stringify(d, undefined, 4) : d).join("\n"));
                    break;
                case "textarea":
                    document.getElementById("logArea").value += data.map(d => typeof d == "object" ? JSON.stringify(d, undefined, 4) : d).join("\n") + "\n\n";
                    break;
            }
        }

        async function request(url, method = "GET", body = undefined, token = accessToken) {
            let headers = {};
            if (body) {
                headers = { ...headers, "content-type": "application/json" }
            }
            if (token) {
                headers = { ...headers, authorization: "Bearer " + token }
            }
            const res = await fetch(loginUrl + url, {
                headers,
                method: method,
                body: JSON.stringify(body)
            });
            if (res.status <= 299 || res.status >= 200) {
                if (res.headers.get("content-type").startsWith("application/json")) {
                    const json = await res.json();
                    log(`${method} ${loginUrl}${url}`, json);
                    return json;
                } else {
                    log(`${method} ${loginUrl}${url} did not return JSON?!`);
                    throw new Error();
                }
            } else {
                if (res.headers.get("content-type").startsWith("application/json")) {
                    log(`${method} ${loginUrl}${url} failed with code ${res.status}`, await res.json());
                    throw new Error();
                } else {
                    log(`${method} ${loginUrl}${url} failed with code ${res.status}`, res.statusText);
                    throw new Error();
                }
            }
        }
    </script>
</head>

<body>
    <h1>Gropius-Login-Tester</h1>
    <h3>Settings:</h3>
    <table>
        <tbody>
            <tr>
                <td>Gropius system hostname (no port):</td>
                <td><input id="hostname"></td>
            </tr>
            <tr>
                <td>Access token:</td>
                <td><input id="accessToken"></td>
            </tr>
            <tr>
                <td>Output responses to:</td>
                <td>
                    <select id="outputLocation">
                        <option value="console" selected>Dev-Console</option>
                        <option value="alert">Popup</option>
                        <option value="textarea">Textbox at bottom</option>
                        <option value="console+alert">Console + Popup</option>
                    </select>
                </td>
            </tr>
        </tbody>
    </table>

    <h3>Requests</h3>

    <h4>Show all existing
        <select class="inField" id="showInstanceType" value="userpass">
            <option value="userpass" selected>userpass</option>
            <option value="github">github</option>
        </select>
        strategy instances
    </h4>
    <ul>
        <li>GET <span class="url"></span>login/strategy/<span class="showInstanceTypeOut"></span>/instance</li>
        <li><button onclick="
                    request(`login/strategy/${val('showInstanceType')}/instance`)
                    .then(r => {
                        if (r.length <= 0) {
                            return;
                        }
                        if (r[0].type == 'userpass') {
                            setVal('userpassLoginInstanceId', r[0].id)
                        } else if (r[0].type =='github') {
                            setVal('createGithubInstanceEditId', r[0].id);
                            setVal('oauthFlowInstanceId', r[0].id);
                            setVal('createGithubInstanceIsLoginActive', r[0].isLoginActive);
                            setVal('createGithubInstanceIsSelfRegisterActive', r[0].isSelfRegisterActive);
                            setVal('createGithubInstanceIsSyncActive', r[0].isSyncActive);
                            setVal('createGithubInstanceDoesImplicitRegister', r[0].doesImplicitRegister);
                        }
                        })">Request</button>
        </li>
    </ul>

    <h4>Log in using username and password</h4>
    <ul>
        <li>Use strategy instance of type userpass with id <input id="userpassLoginInstanceId" class="inField"> (request
            above)</li>
        <li>Username: <input id="userpassLoginUsername" class="inField" value=""> Password: <input
                id="userpassLoginPassword" class="inField" value=""></li>
        <li>POST <span class="url"></span>authenticate/oauth/<span class="userpassLoginInstanceIdOut"></span>/token</li>
        <li class="body">{
            "grant_type": "password",
            "username": "<span class="userpassLoginUsernameOut"></span>",
            "password": "<span class="userpassLoginPasswordOut"></span>"
            }
        </li>
        <li><button onclick="
                    request(`authenticate/oauth/${val('userpassLoginInstanceId')}/token`, 'POST', {grant_type: 'password', username: val('userpassLoginUsername'), password: val('userpassLoginPassword')})
                    .then(r => {setVal('accessToken', r.access_token); setVal('refreshTokenValue', r.refresh_token)})
                    ">Request</button>
        </li>
        </li>
    </ul>

    <h4>Refresh token</h4>
    <ul>
        <li>Refresh token: <input id="refreshTokenValue" class="inField"></li>
        <li>POST <span class="url"></span>authenticate/oauth/this-does-not-matter/token</li>
        <li class="body">{
            "grant_type": "refresh_token",
            "refresh_token": "<span class="refreshTokenValueOut"></span>"
            }
        </li>
        <li><button onclick="
                    request(`authenticate/oauth/a/token`, 'POST', {grant_type: 'refresh_token', refresh_token: val('refreshTokenValue')})
                    .then(r => {setVal('accessToken', r.access_token); setVal('refreshTokenValue', r.refresh_token)})
                    ">Request</button>
        </li>
        </li>
    </ul>

    <h4>List all gropius users (Check if you have admin access)
    </h4>
    <ul>
        <li>GET <span class="url"></span>login/user</li>
        <li><button onclick="request(`login/user`)">Request</button>
        </li>
    </ul>

    <h4>
        <select id="createGithubInstanceMethod" class="inField" oninput="methodTypeChange(event)">
            <option value="POST">Create new</option>
            <option value="PUT">Edit existing</option>
        </select> github strategy instance
    </h4>
    <ul>
        <li id="createGithubInstanceIdText" style="display: none;">Id of instance to edit: <input
                id="createGithubInstanceEditId" class="inField"></li>
        <li>GitHub OAuth App Settings: Client id: <input id="createGithubInstanceClientId" class="inField"><br>
            Client secret: <input id="createGithubInstanceClientSecret" class="inField"></li>
        <li>Settings for this instance:
            <input type="checkbox" id="createGithubInstanceIsLoginActive" class="inField"><label
                for="createGithubInstanceIsLoginActive">Enable login</label>;
            <input type="checkbox" id="createGithubInstanceIsSelfRegisterActive" class="inField"><label
                for="createGithubInstanceIsSelfRegisterActive">Enable self
                registration</label>;
            <input type="checkbox" id="createGithubInstanceIsSyncActive" class="inField"><label
                for="createGithubInstanceIsSyncActive">Enable sync</label>;
            <input type="checkbox" id="createGithubInstanceDoesImplicitRegister" class="inField"><label
                for="createGithubInstanceDoesImplicitRegister">Allow implicit
                register</label>
        </li>
        <li><span class="createGithubInstanceMethodOut"></span> <span
                class="url"></span>login/strategy/github/instance/<span class="createGithubInstanceEditIdOut"
                style="display: none;"></span>
        </li>
        <li class="body">{ <br>
            "instanceConfig": {
            "clientId": "<span class="createGithubInstanceClientIdOut"></span>",
            "clientSecret": "<span class="createGithubInstanceClientSecretOut"></span>"
            },<br>
            "isLoginActive": <span class="createGithubInstanceIsLoginActiveOut"></span>, "isSelfRegisterActive": <span
                class="createGithubInstanceIsSelfRegisterActiveOut"></span>,<br>
            "isSyncActive": <span class="createGithubInstanceIsSyncActiveOut"></span>, "doesImplicitRegister": <span
                class="createGithubInstanceDoesImplicitRegisterOut"></span><br>
            }
        </li>
        <li><button onclick="
                    request(
                        `login/strategy/github/instance${val('createGithubInstanceMethod') == 'PUT' ? ('/'+val('createGithubInstanceEditId')) : ''}`, 
                        val('createGithubInstanceMethod'), {
                            'instanceConfig': {'clientId': val('createGithubInstanceClientId'), 'clientSecret': val('createGithubInstanceClientSecret')},
                            'isLoginActive': val('createGithubInstanceIsLoginActive'), 'isSelfRegisterActive': val('createGithubInstanceIsSelfRegisterActive'),
                            'isSyncActive': val('createGithubInstanceIsSyncActive'), 'doesImplicitRegister': val('createGithubInstanceDoesImplicitRegister')
                        })
                    .then(r => {
                        setVal('createGithubInstanceEditId', r.id);
                        setVal('oauthFlowInstanceId', r.id);
                    })
                    ">Request</button>
        </li>
        </li>
    </ul>

    <h4>List all OAuth clients (Needs admin)
    </h4>
    <ul>
        <li>GET <span class="url"></span>login/client</li>
        <li><button onclick="
        request(`login/client`)
        .then(r => {
            const client = ((r.filter(c => !c.requiresSecret))[0] || r[0])
            setVal('oauthFlowClientId', client.id);
            setVal('createClientEditId', client.id);
            setVal('createClientRedirectUrls', client.redirectUrls.join(';'));
            setVal('createClientIsValid', client.isValid);
            setVal('createClientRequiresSecret', client.requiresSecret);
        })
        ">Request</button>
        </li>
    </ul>

    <h4>
        <select id="createClientMethod" class="inField" oninput="methodTypeChange(event)">
            <option value="POST">Create new</option>
            <option value="PUT" selected>Edit existing</option>
        </select> OAuth Client
    </h4>
    <ul>
        <li id="createClientIdText">Id of OAuth client to edit: <input id="createClientEditId" class="inField"></li>
        <li>Valid redirect URLs (separated by &quot;;&quot;) <input id="createClientRedirectUrls"></li>
        <li>Settings for this client:
            <input type="checkbox" id="createClientIsValid" class="inField" checked><label
                for="createClientIsValid">Enable client</label>;
            <input type="checkbox" id="createClientRequiresSecret" class="inField"><label
                for="createClientRequiresSecret">Require client secret</label>
        </li>
        <li><span class="createClientMethodOut"></span> <span class="url"></span>login/client/<span
                class="createClientEditIdOut"></span>
        </li>
        <li class="body">{ <br>
            "redirectUrls": <span class="createClientRedirectUrlsOut"></span>,<br>
            "isValid": <span class="createClientIsValidOut"></span>, "requiresSecret": <span
                class="createClientRequiresSecretOut"></span>,<br>
            }
        </li>
        <li><button onclick="
                    request(
                        `login/client${val('createClientMethod') == 'PUT' ? ('/'+val('createClientEditId')) : ''}`, 
                        val('createClientMethod'), {
                            redirectUrls: createClientRedirectUrls,
                            isValid: val('createClientIsValid'), requiresSecret: val('createClientRequiresSecret'),
                        })
                    .then(r => {
                        setVal('createClientEditId', r.id);
                        setVal('oauthFlowClientId', r.id);
                    })
                    ">Request</button>
        </li>
        </li>
    </ul>

    <h4>Run OAuth flow</h4>
    <ul>
        <li>Github-Strategy instance id to use: <input id="oauthFlowInstanceId" class="inField"> (request at the top)
        </li>
        <li>Id of the client to initiate: <input id="oauthFlowClientId" class="inField"> (request above)</li>
        <li>Start flow by choosing a mode and clicking initiate (opens in new tab; DON'T close that tab):
            <ul>
                <li>Mode:
                    <select id="oauthFlowMode" class="inField">
                        <option value="login" selected>Login with GitHub (requires being registered or registeres if
                            implicit registration is active)</option>
                        <option value="register">Register with GitHub (Don't allow sync)</option>
                        <option value="register-sync">Register with GitHub (Allow sync)</option>
                    </select>
                </li>
                <li>Redirect user to: GET <span class="url"></span>authenticate/oauth/<span
                        class="oauthFlowInstanceIdOut"></span>/authorize/<span
                        class="oauthFlowModeOut"></span>?client_id=<span class="oauthFlowClientIdOut"></span></li>
                <li><button onclick="oauthFlowInitiate()">Initiate</button></li>
            </ul>
        </li>
        <li>
            Request an access token using the retrieved code:<ul>
                <li>Code: <input id="oauthFlowAuthorizationCode" class="inField"></li>
                <li>POST <span class="url"></span>authenticate/oauth/<span class="oauthFlowInstanceIdOut"></span>/token
                </li>
                <li class="body">{
                    grant_type: "authorization_code",
                    code: "<span class="oauthFlowAuthorizationCodeOut"></span>",
                    }</li>
                <li><button
                        onclick="request(`authenticate/oauth/${val('oauthFlowClientId')}/token`, 'POST', { grant_type: 'authorization_code', code: val('oauthFlowAuthorizationCode') })">Request</button>
                </li>
        </li>
    </ul>

    <h3>Log (if enabled)</h3>
    <textarea
        style="font-family: 'Cascadia Mono', 'Consolas', 'Courier New', Courier, monospace; width: 100%; height: 20em;"
        id="logArea"></textarea>

    <script>
        const hostname = document.getElementById("hostname");
        const urlFields = document.getElementsByClassName("url");
        const inField = document.getElementsByClassName("inField");
        const accessTokenField = document.getElementById("accessToken");
        const refreshTokenField = document.getElementById("refreshTokenValue");
        const createClientRedirectUrlsField = document.getElementById("createClientRedirectUrls");
        const openedWindows = [];

        function storeToStorage() {
            localStorage.setItem("gropius-login-debug", JSON.stringify({ host: hostname.value, accessToken: accessToken || "", refreshToken: refreshTokenField.value }));
        }

        function loadFromStorage() {
            const stored = JSON.parse(localStorage.getItem("gropius-login-debug") || "{}")
            hostname.value = stored.host || "http://localhost";
            accessTokenField.value = stored.accessToken || "";
            refreshTokenField.value = stored.refreshToken || "";
            onAccessTokenChange(false);
            onHostnameChange(false);
        }

        function onHostnameChange(store = true) {
            loginUrl = hostname.value + ":3000/";
            for (let f of urlFields) {
                f.innerText = loginUrl;
            }
            if (store) {
                storeToStorage();
            }
        }

        function onAccessTokenChange(store = true) {
            if (!accessTokenField.value || accessTokenField.value.trim().length == 0) {
                accessToken = undefined;
            } else {
                accessToken = accessTokenField.value;
            }
            if (store) {
                storeToStorage();
            }
        }

        function onDataInput(e) {
            const outFields = document.getElementsByClassName(e.target.id + "Out");
            let value = e.target.value
            if (e.target.type == "checkbox") {
                value = e.target.checked ? "true" : "false";
            }
            for (const f of outFields) {
                f.innerText = value;
            }
            if (e.target == hostname) {
                onHostnameChange();
            } else if (e.target == accessTokenField) {
                onAccessTokenChange();
            } else if (e.target == refreshTokenField) {
                storeToStorage();
            } else if (e.target == createClientRedirectUrlsField) {
                redirectUrlsChanged(e);
            }
        }

        function setVal(id, value) {
            const element = document.getElementById(id);
            if (element.type == "checkbox") {
                element.checked = value ? true : false;
            } else {
                element.value = value;
            }
            onDataInput({ target: element });
        }

        function val(id) {
            const element = document.getElementById(id);
            if (element.type == "checkbox") {
                return element.checked ? true : false;
            }
            return element.value;
        }

        function methodTypeChange(e) {
            const idPrefix = e.target.id.replace(/Method$/, "");
            document.getElementById(idPrefix + "IdText").style.display = e.target.value == "PUT" ? "" : "none";
            const fields = document.getElementsByClassName(idPrefix + "EditIdOut")
            for (const f of fields) {
                f.style.display = e.target.value == "PUT" ? "" : "none";
            }
        }

        function redirectUrlsChanged(e) {
            const outFields = document.getElementsByClassName(e.target.id + "Out");
            createClientRedirectUrls = (e.target.value || "").split(";").map(url => url.trim()).filter(url => url.length > 0);
            const strUrls = "[" + createClientRedirectUrls.map(url => "\"" + url + "\"").join(", ") + "]";
            for (const f of outFields) {
                f.innerText = strUrls;
            }
        }

        function oauthFlow404(window, e) {
            console.log(e);
            debugger;
        }

        function oauthFlowInitiate() {
            for (const tab of openedWindows) {
                if (!tab.closed) {
                    tab.close();
                }
            }
            openedWindows.splice(0, openedWindows.length);
            //const oauthTab = window.open(`${loginUrl}authenticate/oauth/${val("oauthFlowInstanceId")}/authorize/${val("oauthFlowMode")}?client_id=${val("oauthFlowClientId")}`, "_blank");
            const oauthTab = window.open(`http://example.com/test`, "_blank");
            oauthTab.onerror = oauthFlow404.bind(oauthTab);
            openedWindows.push(oauthTab);
        }

        function oauthFlowReturn(e) {
            console.log("Code: " + e.data)
            setVal("oauthFlowAuthorizationCode", e.data);
            // todo: set client id, instance id from returned code
        }

        loadFromStorage();

        hostname.addEventListener("input", onHostnameChange);
        accessTokenField.addEventListener("input", onAccessTokenChange);
        createClientRedirectUrlsField.addEventListener("input", redirectUrlsChanged);
        redirectUrlsChanged({ target: createClientRedirectUrlsField });
        for (const f of inField) {
            f.addEventListener("input", onDataInput);
            onDataInput({ target: f });
        }

        window.addEventListener("message", oauthFlowReturn);
        if (oauthCode) {
            oauthFlowReturn(oauthCode);
        }
    </script>
</body>

</html>